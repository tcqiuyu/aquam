{% extends "base.html" %}
{% load staticfiles %}

{% block header %}
    <link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.14/dgrid/css/dgrid.css">
    <link rel="stylesheet" type="text/css" href="{% static 'css/geoanalytics.css' %}"/>
    <style type="text/css">
        .map{
            position:relative;
            width:100%;
            height:700px;
            border: 1px solid #A4A4A4;
            border-radius: 3px;
        }
        .map-legend {
            position: absolute;
            right: 10px;
            bottom: 40px;
            background-color: white;
            border-radius: 5px;
        }
        #legend1{
            height: 180px;
            width: 110px;
        }
        #legend2 {
            height: 310px;
            width: 170px;
        }
        #legend3 {
            height: 200px;
            width: 110px;
        }
        #direction-details{
            height: 400px;
            width: 100%;
            border: 1px solid #A4A4A4;
            border-radius: 3px;
        }
        #grid{
            height: 100%;
        }
        .dgrid-row{
            padding:5px;
            margin-bottom:5px;
            min-height:50px;
            border-bottom: solid 1px #C0C0C0;
        }
        .dgrid-row .detail div {
            cursor: pointer;
        }
        .dgrid-row .detail div:hover{
            text-decoration:underline;
        }
        .distance{
            float:right;
            color:#C0C0C0;
            font-style:italic;
        }
        #cost{
            border: 1px solid #A4A4A4;
            border-radius: 3px;
        }
    </style>
{% endblock %}

{% block mainbody %}
    <div class="jumbotron">
        <div class="container">
            <h2>Transportantion & Cost Optimizer</h2>
            <p style="text-align: justify">
                This optimizer is an interactive tool designed to optimize the route for produced water transportation.
                An optimized route will help to minimize the cost and save time.
            </p>
        </div>
    </div>
    
    <div class="container">
        <ul id="map-tabs" class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a data-toggle="tab" href="#service-area">Service Area</a></li>
            <li role="presentation"><a data-toggle="tab" href="#nearest-facility" onclick="load_map2()">Nearest Facility</a></li>
            <li role="presentation"><a data-toggle="tab" href="#transportation-cost" onclick="load_map3()">Transportation Cost</a></li>
        </ul>
        <div class="tab-content">
            <div id="service-area" role="tabpanel" class="tab-pane active">
                <div id="toolbar1">
                    <button id="facility-point" name="point" class="btn btn-default">Add Treatment Facility</button>
                    <input id="minutes" type="text" name="mins" value="10"> mins
                    <button id="calculate-service-area" class="btn btn-default">Calculate Service Area</button>
                    <button id="clear-all" name="clear" class="btn btn-default">Clear</button>
                </div>
                <div class="map">
                    <div id="map1"></div>
                    <div class="map-legend">
                        <div id="legend1"></div>
                    </div>
                </div>
                <h4>Service Area Details</h4>
                <div id="service-area-details">
                    <div id="service-area-grid"></div>
                </div>
            </div>
            
            <div id="nearest-facility" role="tabpanel" class="tab-pane">
                <div id="toolbar2">
                    <button id="draw-rectangle" name="rectangle" class="btn btn-default">Rectangle</button>
                    <button id="draw-circle" name="circle" class="btn btn-default">Circle</button>
                    <button id="draw-freehandPolygon" name="freehandPolygon" class="btn btn-default">Polygon</button>
                    <button id="clear-them" class="btn btn-default">Clear</button>
                </div>
                <div class="map">
                    <div id="map2"></div>
                    <div class="map-legend">
                        <div id="legend2"></div>
                    </div>
                </div>
            </div>
            
            <div id="transportation-cost" role="tabpanel" class="tab-pane">
                <div class="map">
                    <div id="map3"></div>
                    <div class="map-legend">
                        <div id="legend3"></div>
                    </div>
                </div>
                <h4>Route Details</h4>
                <div id="direction-details">
                    <div id="grid"></div>
                </div>
                <h4>Cost Calculation</h4>
                <div id="cost">
                    <p>Total Distance: <span id="total-distance">______</span> miles</p>
                    <p>Total Drive Time: <span id="total-time">______</span> minutes</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block footer %}
<script src="http://js.arcgis.com/3.13/"></script>
<script type="text/javascript">
    $(document).ready(function(){
        load_map1();
    });
</script>

<script type="text/javascript">
    // tab1
    function load_map1(){
        require([
            "esri/Color",
            "esri/dijit/Legend",
            "esri/dijit/Scalebar",
            "esri/dijit/PopupTemplate",
            "esri/graphic",
            "esri/geometry/geometryEngine",
            "esri/layers/FeatureLayer",
            "esri/layers/GraphicsLayer",
            "esri/map",
            "esri/renderers/SimpleRenderer",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/tasks/FeatureSet",
            "esri/tasks/GeometryService",
            "esri/tasks/query",
            "esri/tasks/ServiceAreaParameters",
            "esri/tasks/ServiceAreaTask",
            "esri/toolbars/draw",
            "dojo/_base/array",
            "dojo/dom",
            "dojo/on",
            "dojo/domReady!"
        ], function(
            Color,
            Legend,
            Scalebar,
            PopupTemplate,
            Graphic,
            geometryEngine,
            FeatureLayer,
            GraphicsLayer,
            Map,
            SimpleRenderer,
            SimpleFillSymbol,
            SimpleLineSymbol,
            SimpleMarkerSymbol,
            FeatureSet,
            GeometryService,
            Query,
            ServiceAreaParameters,
            ServiceAreaTask,
            Draw,
            arrayUtils,
            dom,
            on
        ){
            //map
            var map = new Map("map1", {
                basemap: "streets",
                center: [-98.38, 28.8],
                zoom: 9
            });
            map.on("load", function(){
                map.disableScrollWheelZoom();
            });
            
            // well layer
            var wellsRenderer = new SimpleRenderer({
                symbol: {
                    type: "esriSMS",
                    style: "esriSMSCircle",
                    outline: {
                        width: 0.5,
                        color: [160, 160, 160, 70],
                    },
                    size: 6
                },
                colorInfo: {
                    field: "water_use",
                    minDataValue: 20000,
                    maxDataValue: 260000,
                    colors: [
                        new Color([0, 0, 255]),
                        new Color([0, 255, 0]),
                        new Color([255, 255, 0]),
                        new Color([255, 0, 0])
                    ]
                }
            });
            var wellServiceUrl = "http://services1.arcgis.com/KNdRU5cN6ENqCTjk/arcgis/rest/services/WaterUsePoint/FeatureServer/0";
            var wellsLayer = new FeatureLayer(wellServiceUrl, {
                mode: FeatureLayer.MODE_SNAPSHOT,
                outFields: ["water_use"]
            });
            wellsLayer.setRenderer(wellsRenderer);
            map.addLayer(wellsLayer);
            
            // legend
            var legend = new Legend({
                map: map
            }, "legend1");
            legend.startup();
            legend.refresh([{
                layer: wellsLayer,
                title: " "
            }]);
            
            //scalebar
            var scalebar = new Scalebar({
                map: map,
                scalebarUnit: "dual"
            });
            
            //add two graphics layer for point & area
            var features = [];
            var pointGraphicsLayer = new GraphicsLayer();
            var areaGraphicsLayer = new GraphicsLayer();
            map.addLayer(pointGraphicsLayer);
            map.addLayer(areaGraphicsLayer);
            
            // draw
            var toolbar = new Draw(map);
            on(dom.byId("toolbar1"), "click", function (event) {
                if (event.target.id === "toolbar1") {
                    return;
                }
                if (event.target.id === "clear-all") {
                    pointGraphicsLayer.clear();
                    areaGraphicsLayer.clear();
                    wellsLayer.clearSelection();
                    features = [];
                    return;
                }
                var tool = event.target.name.toLowerCase();
                if (event.target.id === "facility-point") {
                    toolbar.activate(tool);
                    toolbar.on("draw-end", function (event) {
                        toolbar.deactivate();
                        var pointGraphic = new Graphic();
                        var pointSymbol = new SimpleMarkerSymbol({
                            type: "esriSMS",
                            style: "esriSMSSquare",
                            outline: {
                                width: 0.5,
                                color: [160, 160, 160, 70],
                            },
                            size: 13,
                            color: new Color([255,10,10])
                        });
                        pointGraphic.setGeometry(event.geometry);
                        pointGraphic.setSymbol(pointSymbol);
                        pointGraphicsLayer.add(pointGraphic);
                        features.push(pointGraphic);
                    });
                }
            });
            
            // add service area
            on(dom.byId("calculate-service-area"), "click", function(event){
                if (features.length < 1) {
                    return;
                }
                // service area parameters
                var saParams = new ServiceAreaParameters();
                var facilities = new FeatureSet();
                facilities.features = features;
                saParams.facilities = facilities;
                saParams.defaultBreaks= [dom.byId("minutes").value];
                saParams.outSpatialReference = map.spatialReference;
                saParams.returnFacilities = false;
                // service area task
                var naServiceUrl = "https://utility.arcgis.com/usrsvcs/servers/9f6aa15d974b496f8199b67c24b28245/rest/services/World/ServiceAreas/NAServer/ServiceArea_World";
                var serviceAreaTask = new ServiceAreaTask(naServiceUrl);
                serviceAreaTask.solve(saParams, function(solveAreas){
                    var polygonSymbol = new SimpleFillSymbol(
                        "solid",  
                        new SimpleLineSymbol("solid", new Color([232,104,80]), 2),
                        new Color([232,104,80,0.25])
                    );
                    arrayUtils.forEach(solveAreas.serviceAreaPolygons, function(serviceArea){
                        convexServiceArea = geometryEngine.convexHull(serviceArea.geometry);
                        // add service area to map
                        var areaGraphic = new Graphic(convexServiceArea, polygonSymbol)
                        areaGraphicsLayer.add(areaGraphic);
                        // summarize
                        var query = new Query();
                        query.geometry = areaGraphic.geometry;
                        wellsLayer.selectFeatures(query, FeatureLayer.SELECTION_NEW, function(features){
                            var totalWaterUse = 0.0;
                            var featuresNumber = features.length;
                            arrayUtils.forEach(features, function (feature) {
                                totalWaterUse += feature.attributes.water_use;
                            });
                            var meanWaterUse = totalWaterUse / featuresNumber;
                            data = {
                                "totalWaterUse": Math.round(totalWaterUse),
                                "meanWaterUse":Math.round(meanWaterUse)
                            };
                            console.log(data);
                        });
                    });
                });
            });
        });
    }
</script>

<script type="text/javascript">
    // tab2
    var map2_clicked = false;
    function load_map2(){
        if (!map2_clicked){
            require([
                "esri/Color",
                "esri/dijit/Legend",
                "esri/dijit/Scalebar",
                "esri/dijit/PopupTemplate",
                "esri/graphic",
                "esri/geometry/Point",
                "esri/layers/FeatureLayer",
                "esri/map",
                "esri/renderers/SimpleRenderer",
                "esri/symbols/SimpleFillSymbol",
                "esri/symbols/SimpleLineSymbol",
                "esri/symbols/SimpleMarkerSymbol",
                "esri/tasks/ClosestFacilityTask",
                "esri/tasks/ClosestFacilityParameters",
                "esri/tasks/FeatureSet",
                "esri/tasks/GeometryService",
                "esri/tasks/query",
                "esri/tasks/ServiceAreaParameters",
                "esri/tasks/ServiceAreaTask",
                "esri/toolbars/draw",
                "dojo/_base/array",
                "dojo/dom",
                "dojo/on",
                "dojo/domReady!"
            ], function(
                Color,
                Legend,
                Scalebar,
                PopupTemplate,
                Graphic,
                Point,
                FeatureLayer,
                Map,
                SimpleRenderer,
                SimpleFillSymbol,
                SimpleLineSymbol,
                SimpleMarkerSymbol,
                ClosestFacilityTask,
                ClosestFacilityParameters,
                FeatureSet,
                Query,
                GeometryService,
                ServiceAreaParameters,
                ServiceAreaTask,
                Draw,
                arrayUtils,
                dom,
                on
            ){
                //map
                var map = new Map("map2", {
                 basemap: "streets",
                 center: [-98.38, 28.8],
                 zoom: 9
                });
                map.on("load", function(){
                    map.disableScrollWheelZoom();
                });
                
                // well layer
                var wellsRenderer = new SimpleRenderer({
                    symbol: {
                        type: "esriSMS",
                        style: "esriSMSCircle",
                        outline: {
                         width: 0.5,
                         color: [160, 160, 160, 70],
                        },
                        size: 6
                    },
                    colorInfo: {
                        field: "water_use",
                        minDataValue: 20000,
                        maxDataValue: 260000,
                        colors: [
                            new Color([0, 0, 255]),
                            new Color([0, 255, 0]),
                            new Color([255, 255, 0]),
                            new Color([255, 0, 0])
                        ]
                    }
                });
                // selection symbol
                var selectionSymbol = new SimpleMarkerSymbol({
                    type: "esriSMS",
                    style: "esriSMSCircle",
                    size: 8,
                    color: new Color([207, 34, 171, 0.5])
                });
                var wellServiceUrl = "http://services1.arcgis.com/KNdRU5cN6ENqCTjk/arcgis/rest/services/WaterUsePoint/FeatureServer/0";
                var wellsLayer = new FeatureLayer(wellServiceUrl, {
                    mode: FeatureLayer.MODE_SNAPSHOT,
                    outFields: ["water_use"]
                });
                wellsLayer.setRenderer(wellsRenderer);
                wellsLayer.setSelectionSymbol(selectionSymbol);
                
                // injection wells layer
                var injectionWellRenderer = new SimpleRenderer({
                    symbol: {
                        type: "esriSMS",
                        style: "esriSMSSquare",
                        outline: {
                            width: 0.5,
                            color: [160, 160, 160, 70],
                        },
                        size: 10,
                        color: new Color([20,20,255])
                    }
                });
                var injectionWellTemplate = new PopupTemplate({
                    fieldInfos: [
                        {
                            fieldName: "Name",
                            label: "Name",
                            visible: true
                        }
                    ]
                });
                var injectionWellServiceUrl = "http://services1.arcgis.com/KNdRU5cN6ENqCTjk/arcgis/rest/services/InjectionWells/FeatureServer/0";
                var injectionWellsLayer = new FeatureLayer(injectionWellServiceUrl, {
                    mode: FeatureLayer.MODE_SNAPSHOT,
                    infoTemplate: injectionWellTemplate,
                    outFields: ["Name"]
                });
                injectionWellsLayer.setRenderer(injectionWellRenderer);
                map.addLayers([wellsLayer, injectionWellsLayer]);

                // legend
                var legend = new Legend({
                    map: map
                }, "legend2");
                legend.startup();
                
                //scalebar
                var scalebar = new Scalebar({
                    map: map,
                    scalebarUnit: "dual"
                });
                
                // nearest facilities
                var cfServiceUrl = "http://utility.arcgis.com/usrsvcs/servers/1e3c79d2d2684f33806420f2fde7111b/rest/services/World/ClosestFacility/NAServer/ClosestFacility_World";
                var closestFacilityTask = new ClosestFacilityTask(cfServiceUrl);
                var cfParams = new ClosestFacilityParameters();
                cfParams.impedenceAttribute= "Miles";
                cfParams.returnIncidents=false;
                cfParams.returnRoutes=true;
                cfParams.returnDirections=false;
                var facilities = new FeatureSet();
                facilities.features = injectionWellsLayer.graphics;
                cfParams.facilities = facilities;
                cfParams.outSpatialReference = map.spatialReference;
                cfParams.defaultTargetFacilityCount = 1;
                var routeSymbol = new SimpleLineSymbol({
                    color: new Color([20, 20, 255]),
                    style: "STYLE_SOLID",
                    width: 2
                });
                var toolbar = new Draw(map);
                on(dom.byId("toolbar2"), "click", function (event) {
                    if (event.target.id === "toolbar2") {
                        return;
                    }
                    if (event.target.id === "clear-them") {
                        map.graphics.clear();
                        wellsLayer.clearSelection();
                        return;
                    }
                    var tool = event.target.name.toLowerCase();
                    toolbar.activate(tool);
                    console.log("loop1");
                    toolbar.on("draw-end", function (event) {
                        toolbar.deactivate();
                        var graphic = new Graphic();
                        var fillSymbol = new SimpleFillSymbol({
                            type: "esriSFS",
                            style: "esriSFSSolid",
                            color: [100, 100, 100, 50],
                            outline: new SimpleLineSymbol()
                        });
                        graphic.setGeometry(event.geometry);
                        graphic.setSymbol(fillSymbol);
                        //map.graphics.add(graphic);
                        map.graphics.clear();
                        // query
                        var query = new Query();
                        query.geometry = event.geometry;
                        console.log("loop2");
                        wellsLayer.selectFeatures(query, FeatureLayer.SELECTION_NEW, function(features){
                            if (features.length < 1){
                                return;
                            }
                            // find the centroid of the group of selected points
                            var points = dojo.map(features,function(feature){
                                return feature.geometry;
                            });
                            var xSum = 0.0;
                            var ySum = 0.0;
                            arrayUtils.forEach(points, function(point){
                                xSum += point.x;
                                ySum += point.y;
                            });
                            xCenter = xSum / points.length;
                            yCenter = ySum / points.length;
                            var centroid = new Point(xCenter, yCenter, map.spatialReference);
                            centroidGraphic = new Graphic(centroid, new SimpleMarkerSymbol({
                                type: "esriSMS",
                                style: "esriSMSCross",
                                outline: {
                                    width: 2,
                                    color: new Color([255, 0, 0]),
                                },
                                size: 13,
                                color: new Color([255,0,0])
                            }));
                            map.graphics.add(centroidGraphic);
                            var incidents = new FeatureSet();
                            incidents.features = [centroidGraphic];
                            cfParams.incidents = incidents;
                            
                            // find the nearest facility
                            closestFacilityTask.solve(cfParams, function(solveResult){
                                arrayUtils.forEach(solveResult.routes, function(route, index){
                                    map.graphics.add(route.setSymbol(routeSymbol));
                                });
                            });
                        });
                    });
                });
            });
            map2_clicked = true;
        }
    }
</script>

<script type="text/javascript">
    // tab3
    var map3_clicked = false;
    function load_map3(){
        if (!map3_clicked) {
            require([
                "esri/Color",
                "esri/dijit/Scalebar",
                "esri/graphic",
                "esri/lang",
                "esri/map",
                "esri/symbols/SimpleMarkerSymbol",
                "esri/symbols/SimpleLineSymbol",
                "esri/tasks/FeatureSet",
                "esri/tasks/RouteParameters",
                "esri/tasks/RouteTask",
                "dojo/_base/array",
                "dojo/dom-construct",
                "dgrid/Grid",
                "dojo/dom",
                "dojo/on",
                "dojo/domReady!"
            ], function(
                Color,
                Scalebar,
                Graphic,
                esriLang,
                Map,
                SimpleMarkerSymbol,
                SimpleLineSymbol,
                FeatureSet,
                RouteParameters,
                RouteTask,
                arrayUtils,
                domConstruct,
                Grid,
                dom,
                on
             ){
                //global varible
                var directionFeatures;
                var segmentGraphic;
             
                //map
                var map = new Map("map3", {
                    basemap: "streets",
                    center: [-98.88, 28.5],
                    zoom: 10
                });
                map.on("load", function() {
                    map.disableScrollWheelZoom();
                });
                var scalebar = new Scalebar({
                    map: map,
                    scalebarUnit: "dual"
                });
             
                //add stops
                map.on("click", addStop);
                 
                //routing
                naServiceUrl = "http://utility.arcgis.com/usrsvcs/servers/cc83495aa68841219353131cf078a2ea/rest/services/World/Route/NAServer/Route_World";
                var routeTask = new RouteTask(naServiceUrl);
                var routeParams = new RouteParameters();
                routeParams.stops = new FeatureSet();
                routeParams.outSpatialReference = {
                    "wkid" : 102100
                };
                routeParams.returnDirections = true;
                routeTask.on("solve-complete", showRoute);
                routeTask.on("error", errorHandler);

                //Adds a graphic when the user clicks the map. If 2 or more points exist, route is solved.
                function addStop(event){
                    var stopSymbol = new SimpleMarkerSymbol({
                        type: "esriSMS",
                        style: "esriSMSCircle",
                        color: new Color([255, 40, 40]),
                        size: 12,
                        outline: {
                            width: 0.5,
                            color: new Color([180, 20, 160])
                        }
                    });
                    var grahic = new Graphic(event.mapPoint, stopSymbol);
                    var stop = map.graphics.add(grahic);
                    routeParams.stops.features.push(stop);
                    if (routeParams.stops.features.length >= 2) {
                        routeTask.solve(routeParams);
                        lastStop = routeParams.stops.features.splice(0, 1)[0];
                    }
                }
                
                //Adds the solved route to the map as a graphic
                function showRoute(event) {
                    var gridData = [];
                    if (grid){
                        $("grid").empty();
                    }
                    var routeSymbol = new SimpleLineSymbol({
                        color: new Color([30, 220, 70]),
                        style: "STYLE_SOLID",
                        width: 2
                    });
                    map.graphics.add(event.result.routeResults[0].route.setSymbol(routeSymbol));
                     
                    //Display the route details
                    var directions = event.result.routeResults[0].directions;
                    directionFeatures = directions.features;
                    var directionsInfo = event.result.routeResults[0].directions.features;
                    var totalDistance = Math.round(directions.totalLength, 2);
                    var totalTime = Math.round(directions.totalTime, 2);
                    $("#total-distance").text(totalDistance);
                    $("#total-time").text(totalTime);
                    gridData = arrayUtils.map(directionsInfo,function(feature,index){
                        return {
                            "detail": feature.attributes.text,
                            "distance": Math.round(feature.attributes.length, 2),
                            "index": index
                        };
                    });
                    grid = new Grid({
                        renderRow: renderList,
                        showHeader:false
                    }, "grid");
                    grid.renderArray(gridData);
                    grid.on(".dgrid-row:click", zoomToSegment);
                }
                
                function renderList(obj,options){
                    var template = "<div class='detail'><div style='max-width:70%;float:left;'>${detail}</div><span style='float:right;' class='distance'>${distance} miles</span></div>";       
                    return domConstruct.create("div", { innerHTML: esriLang.substitute(obj, template) });
                }
                
                function zoomToSegment(event) {
                    //Grid row id corresponds to the segment to highlight
                    var index = grid.row(event).id;
                    var segment = directionFeatures[index];
                    var segmentSymbol = new SimpleLineSymbol().setColor(new Color([255,0,0,0.5])).setWidth(8);
                    
                    map.setExtent(segment.geometry.getExtent(), true);
                    if ( !segmentGraphic ) {
                        segmentGraphic = map.graphics.add(new Graphic(segment.geometry, segmentSymbol));
                    } else {
                        segmentGraphic.setGeometry(segment.geometry);
                    }
                }
                //Displays any error returned by the Route Task
                function errorHandler(err) {
                    alert("An error occured\n" + err.message + "\n");
                    routeParams.stops.features.splice(0, 0, lastStop);
                    map.graphics.remove(routeParams.stops.features.splice(1, 1)[0]);
                }
            });
            map3_clicked = true;
        }
    }
</script>
{% endblock %}